#!/bin/sh

# This file is used to check all functions (static or static inline) declared 
# by other layer and used for iscsi code but they can't be solved by WEAK symbol 
# mechanism during to compile / link them
# 
# This file will create iscsi_autogen.h in <kernel_path>/include/qnap path


PWD=$(pwd)
QNAP_ISCSI_AUTOGEN_H=${PWD}/include/qnap/iscsi_autogen.h
CHECK_LIST_FILE=${PWD}/drivers/target/qnap/check_func_list.txt
COMPILE_OPT=""

# One thing we need to take care is this file will be called in makefile
# and append output to ccflags-y, so NOT echo any message during to build code
# except you call script by manual for debug purpose

msg() {
	#echo "[check_func][msg]: $1"
	return 0
}

check_func() {

	local check_file=$1
	local src=""
	local pattern=""
	local opt=""

	msg $check_file

	while read line;do
		ret=$(echo $line | grep "^check_list")
		if [ "$?" != "0" ];then
			continue
		fi
		src=$(echo $line | cut -d : -f 2)
		pattern=$(echo $line | cut -d : -f 3)
		msg "src: $src"
		msg "pattern: $pattern"

		# take care the pattern, if it contains '*', we shall add escape char
		pattern=$(echo ${pattern} | sed 's/*/\\*/g')
		#echo "new pattern: $pattern"

		ret=$(cat ${PWD}/${src} | grep "${pattern}")
		if [ "$?" != "0" ];then
			msg "not found pattern: ${pattern}"
			continue
		fi

		opt=$(echo $line | cut -d : -f 4)
		msg "got opt: $opt"

		COMPILE_OPT=${COMPILE_OPT}"\n#define ${opt}"
		msg "COMPILE_OPT: $COMPILE_OPT"
		
		
	done < $check_file
	
}

## to create iscsi_autogen.h file ##
create_autogen_h() {

cat << EOF > ${QNAP_ISCSI_AUTOGEN_H}

/* This file was auto-generated by script file.
 * For iSCSI pre-posting, some functions declared by other layer didn't be
 * implemented yet, so we use weak symbol mechanism to avoid the compliler
 * will complain during to compile / link them. But, for some functions which
 * were declared by 'static' or 'inline', we shall use another way to solve this
 */
#ifndef ISCSI_AUTOGEN_H
#define ISCSI_AUTOGEN_H
	
$(echo ${COMPILE_OPT})
	
#endif

EOF

}

################
##### main #####
################

if [ -f ${CHECK_LIST_FILE} ];then
	check_func ${CHECK_LIST_FILE}
	create_autogen_h
	## we MUST NEED do this ##
	echo "-D__ISCSI_AUTOGEN__"
	exit 0
fi

msg "[iSCSI] NOT found any check list file: ${CHECK_LIST_FILE}"


